<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stats - تزكيات</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo logo-arabic">تزكيات</a>
      <nav class="nav">
        <!-- Populated by JS -->
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="page-title">
      <h1>Community Stats</h1>
      <p>See how the community is growing</p>
    </div>

    <!-- Overview Stats -->
    <div class="stats-grid" id="overview-stats">
      <div class="stat-card">
        <div class="stat-value" id="stat-users">-</div>
        <div class="stat-label">Members</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-recommendations">-</div>
        <div class="stat-label">Recommendations</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-comments">-</div>
        <div class="stat-label">Comments</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-upvotes">-</div>
        <div class="stat-label">Upvotes</div>
      </div>
    </div>

    <!-- This Week -->
    <div class="stats-section">
      <h3>This Week</h3>
      <div class="stats-grid" style="margin-bottom: 0;">
        <div class="stat-card">
          <div class="stat-value" id="stat-week-recs">-</div>
          <div class="stat-label">New Recommendations</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-week-comments">-</div>
          <div class="stat-label">New Comments</div>
        </div>
      </div>
    </div>

    <!-- Your Stats -->
    <div class="stats-section">
      <h3>Your Contribution</h3>
      <div class="stats-grid" style="margin-bottom: 0;">
        <div class="stat-card">
          <div class="stat-value" id="stat-my-recs">-</div>
          <div class="stat-label">Recommendations</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-my-comments">-</div>
          <div class="stat-label">Comments</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-my-upvotes">-</div>
          <div class="stat-label">Upvotes Received</div>
        </div>
      </div>
    </div>

    <!-- Top Contributors -->
    <div class="stats-section">
      <h3>Top Contributors</h3>
      <div id="top-contributors">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- Most Upvoted -->
    <div class="stats-section">
      <h3>Most Upvoted Recommendations</h3>
      <div id="most-upvoted">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- Popular Tags -->
    <div class="stats-section">
      <h3>Popular Tags</h3>
      <div id="popular-tags" class="tags-filter">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>
  </main>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = await requireAuth();
      if (!currentUser) return;
      
      setupHeader(currentUser);
      loadStats();
    });

    async function loadStats() {
      try {
        const stats = await api.getStats();
        
        // Overview
        document.getElementById('stat-users').textContent = stats.overview.totalUsers;
        document.getElementById('stat-recommendations').textContent = stats.overview.totalRecommendations;
        document.getElementById('stat-comments').textContent = stats.overview.totalComments;
        document.getElementById('stat-upvotes').textContent = stats.overview.totalUpvotes;
        
        // This week
        document.getElementById('stat-week-recs').textContent = stats.thisWeek.recommendations;
        document.getElementById('stat-week-comments').textContent = stats.thisWeek.comments;
        
        // Personal
        document.getElementById('stat-my-recs').textContent = stats.personal.recommendations;
        document.getElementById('stat-my-comments').textContent = stats.personal.comments;
        document.getElementById('stat-my-upvotes').textContent = stats.personal.upvotesReceived;
        
        // Top contributors
        renderLeaderboard('top-contributors', stats.topContributors, 'recommendation_count', 'recs');
        
        // Most upvoted
        renderMostUpvoted(stats.mostUpvoted);
        
        // Popular tags
        renderPopularTags(stats.popularTags);
        
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    function renderLeaderboard(containerId, items, valueKey, suffix) {
      const container = document.getElementById(containerId);
      
      if (items.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted);">No data yet</p>';
        return;
      }
      
      container.innerHTML = items.map((item, index) => `
        <div class="leaderboard-item">
          <span class="leaderboard-rank">#${index + 1}</span>
          <span class="leaderboard-name">${escapeHtml(item.nickname)}</span>
          <span class="leaderboard-value">${item[valueKey]} ${suffix}</span>
        </div>
      `).join('');
    }

    function renderMostUpvoted(items) {
      const container = document.getElementById('most-upvoted');
      
      if (items.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted);">No upvoted recommendations yet</p>';
        return;
      }
      
      container.innerHTML = items.map((item, index) => `
        <div class="leaderboard-item">
          <span class="leaderboard-rank">#${index + 1}</span>
          <span class="leaderboard-name">
            <a href="${escapeHtml(item.url)}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a>
            <br><small style="color: var(--text-muted);">by ${escapeHtml(item.user_nickname)}</small>
          </span>
          <span class="leaderboard-value">${item.upvote_count} votes</span>
        </div>
      `).join('');
    }

    function renderPopularTags(tags) {
      const container = document.getElementById('popular-tags');
      
      if (tags.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted);">No tags yet</p>';
        return;
      }
      
      container.innerHTML = tags.map(tag => `
        <span class="tag" onclick="window.location.href='/?tag=${encodeURIComponent(tag.name)}'">
          ${escapeHtml(tag.name)} (${tag.usage_count})
        </span>
      `).join('');
    }
  </script>
</body>
</html>
